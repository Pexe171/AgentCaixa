services:
  redis:
    image: redis:7-alpine
    container_name: rag_app_redis
    ports:
      - "6379:6379"
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  qdrant:
    image: qdrant/qdrant:v1.13.4
    container_name: rag_app_qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_storage:/qdrant/storage

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag_app_api
    command: uvicorn rag_app.api.main:app --host 0.0.0.0 --port 8000
    ports:
      - "8000:8000"
    environment:
      LLM_PROVIDER: ${LLM_PROVIDER:-mock}
      VECTOR_PROVIDER: ${VECTOR_PROVIDER:-qdrant}
      QDRANT_URL: http://qdrant:6333
      QDRANT_COLLECTION: ${QDRANT_COLLECTION:-rag_app_documents}
      EMBEDDING_CACHE_BACKEND: ${EMBEDDING_CACHE_BACKEND:-redis}
      EMBEDDING_CACHE_REDIS_URL: redis://redis:6379/0
      RESPONSE_CACHE_BACKEND: ${RESPONSE_CACHE_BACKEND:-redis}
      RESPONSE_CACHE_REDIS_URL: redis://redis:6379/1
      SESSION_STORE_BACKEND: ${SESSION_STORE_BACKEND:-memory}
      SEMANTIC_MEMORY_BACKEND: ${SEMANTIC_MEMORY_BACKEND:-sqlite}
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
    depends_on:
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: rag_app_frontend
    command: streamlit run frontend/chat_app.py --server.address=0.0.0.0 --server.port=8501
    ports:
      - "8501:8501"
    environment:
      AGENT_API_URL: http://api:8000/v1/agent/chat
      AGENT_API_TIMEOUT_SECONDS: ${AGENT_API_TIMEOUT_SECONDS:-45}
    depends_on:
      api:
        condition: service_started

volumes:
  qdrant_storage:
